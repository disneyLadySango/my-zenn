---
title: "回避せよCWVスコア悪化、CDNとABテスト〜CWVスコアを維持する挑戦者たち〜"
emoji: "🦔"
type: "tech"
topics: []
published: false
---

こうなんか仰々しいタイトルをつけてみたものの、そんなに壮大な話でもありません。
プロジェクト○みたいなタイトルを付けたかっただけです。

こんにちは、スペースマーケットでエンジニアリングマネージャーをしています。

記事を書くたびに肩書きが変わるね、次はどんな風になっているんだろうね、ハム太郎♪

タイトルの話をする前に前提の話をしていきます。
# CDNとは
そもそもみなさんCDNをご存知でしょうか？
なんかキャッシュとかそういうのだよね？みたいな認識の方はいませんか？
いますよね、私もそうでした（？）

CDNとはContents Delivery Networkの略です。
決してCache Delivery Networkではありません、CDNはキャッシュすることが目的ではないわけです。
CDNはコンテンツをより速くより効率的に配信するために構築されたネットワークのことです。
つまりその機能の一部にキャッシュがあるわけですね。

では他にはどんな機能があるかというと
- 分散配置されたエッジサーバー
- ルーティング
- 画像最適化

などといった機能もあります。
キャッシュだけではないということを覚えておくと良いかと思います。
まあ今回話をするのはキャッシュのお話なんですけどね笑

# CDNを使ったABテスト
さて、CDNを使っている環境でABテストをする場合どのような方法が使えるでしょうか？
ABテストは結局A/Bの切り分けが必要になります。
CDNを使わない場合、基本的にはオリジンサーバーへリクエストが飛ぶためユーザーの振り分けさえできればすぐにでもABテストを行えるわけです。

しかしCDNを使いキャッシュを利用している場合はどうでしょうか？
![CDNキャッシュを利用したレンダリングのイメージ](https://storage.googleapis.com/zenn-user-upload/c73e8ff3cd09-20230414.png)
1度目のリクエストではオリジンサーバーへリクエストが飛びます。
しかし2度目以降のリクエストではCDNからストアされたデータでレスポンスが返却されます。
そのためキャッシュの期限が切れるまではオリジンサーバーにリクエストされず、ABテストの振り分けはストア前の振り分けに依存されてしまい想定の通りにならないわけです。

「さて、それじゃあどうやってABテストをしよう・・・」
「オリジンサーバーにリクエストせずにABテストをするんや！CSRや！！！工藤！！！」
ということでCSRでのABテストが出てきます。

## CSRでのABテスト
CSRでのABテストはレスポンスのHTMLを切り替える方法ではなく、JavaScriptによってクライアントサイドでUIを切り替える方法です。
例えばですがidを持ったボタンがあったとします。
```html
<button id="sample" type="button">ボタン</button>
```

デフォルトのカラーが青だったとした場合、これをHTMLをレンダリングした後に赤などに切り替えると言うことです。
これをJavaScriptで制御します。
```JavaScript
document.getElementById('sample')
```
で要素を取得しbackground-colorなどを上書きするイメージですね。
代表的なサービスで行くと、Googleオプティマイズを使ったABテストはこちらに該当します。
:::message
Googleオプティまずは2023年9月30日でサービス終了するためCSRで実装する場合は、他のサービスを検討してください。
ABTasty、Optimizely、VMOといったサービスがGA4連携を
:::

じゃあCSRでABテストすればいいじゃんという話なのですがそんなに良いことばかりでもありません。

例に出したものがボタンの色を変える内容ですが、これはあくまでJavaScriptが読み込まれてしか実行されません。
そのため、読み込まれる前までは元の色で表示されるわけです。
また、色を変える程度であれば良いですがもっとレイアウト自体を変えたい、要素を消したいという話になってくるとレイアウトシフトが発生しかねません。
Core Web VitalsでいうところのCLSの悪化も気になります。
そのためCSRでABテストするにはかなり小さい規模でのみのテストに限定されてしまいます。

そのためSSRをしつつABテストを実施する方法を探る必要があります。

# SSRとCDNとABテスト
さあSSRでABテストを実施したいわけですが、先ほど説明した通りCDNでキャッシュされてしまうため簡単にはできません。
そのため何かしらの方法を使う必要があるわけです。

そのためにはCDNでキャッシュされる仕組みを理解する必要があります。
